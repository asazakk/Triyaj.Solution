﻿@{
    ViewData["Title"] = "Bekleyen Hastalar";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people-fill"></i> Bekleyen Hastalar</h2>
    <a href="/Encounters/Create" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Yeni Hasta Kayıt
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div id="loadingMessage" class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-2">Hastalar yükleniyor...</p>
        </div>
        <div id="errorMessage" class="alert alert-danger d-none"></div>
        <div id="emptyMessage" class="alert alert-info d-none">
            <i class="bi bi-info-circle"></i> Bekleyen hasta bulunmamaktadır.
        </div>
        <div class="table-responsive">
            <table class="table table-hover" id="patientsTable" style="display: none;">
                <thead class="table-dark">
                    <tr>
                        <th>Sıra</th>
                        <th>Hasta Adı</th>
                        <th>T.C. Kimlik</th>
                        <th>Geliş Zamanı</th>
                        <th>Geliş Şekli</th>
                        <th>Triyaj Seviyesi</th>
                        <th>Vital Bulgular</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="patientsTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Hasta Detay Modal -->
<div class="modal fade" id="patientDetailModal" tabindex="-1" aria-labelledby="patientDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="patientDetailModalLabel">
                    <i class="bi bi-person-badge"></i> Hasta Detayları
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="patientDetailBody">
                <!-- Dinamik içerik -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Kapat
                </button>
                <a href="#" id="triageLink" class="btn btn-warning">
                    <i class="bi bi-clipboard2-pulse"></i> Triyaj Yap
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header" id="toastHeader">
            <i class="bi bi-info-circle me-2" id="toastIcon"></i>
            <strong class="me-auto" id="toastTitle">Bildirim</strong>
            <small>Şimdi</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        .triage-red { background-color: #dc3545 !important; color: white; font-weight: bold; }
        .triage-yellow { background-color: #ffc107 !important; color: black; font-weight: bold; }
        .triage-green { background-color: #28a745 !important; color: white; font-weight: bold; }
        .triage-blue { background-color: #17a2b8 !important; color: white; font-weight: bold; }
        .triage-undefined { background-color: #6c757d !important; color: white; }
        .vital-badge { font-size: 0.75rem; margin: 1px; }
        .detail-label { font-weight: 600; color: #495057; }
        .detail-value { color: #212529; }
        .vital-card { border-left: 4px solid; }
        .vital-card.normal { border-color: #28a745; }
        .vital-card.warning { border-color: #ffc107; }
        .vital-card.danger { border-color: #dc3545; }
    </style>

    <script>
        $(document).ready(function() {
            loadPendingPatients();
        });

        // Toast bildirimi göster
        function showToast(title, message, type) {
            var toast = $('#notificationToast');
            var header = $('#toastHeader');
            var icon = $('#toastIcon');
            var titleEl = $('#toastTitle');
            var body = $('#toastBody');

            // Renk ve ikon ayarla
            header.removeClass('bg-success bg-danger bg-warning bg-info text-white');
            switch(type) {
                case 'success':
                    header.addClass('bg-success text-white');
                    icon.attr('class', 'bi bi-check-circle-fill me-2');
                    break;
                case 'error':
                    header.addClass('bg-danger text-white');
                    icon.attr('class', 'bi bi-x-circle-fill me-2');
                    break;
                case 'warning':
                    header.addClass('bg-warning');
                    icon.attr('class', 'bi bi-exclamation-triangle-fill me-2');
                    break;
                default:
                    header.addClass('bg-info text-white');
                    icon.attr('class', 'bi bi-info-circle-fill me-2');
            }

            titleEl.text(title);
            body.html(message);

            var bsToast = new bootstrap.Toast(toast[0], { delay: 5000 });
            bsToast.show();
        }

        function loadPendingPatients() {
            $.ajax({
                url: '/api/encounters/pending',
                type: 'GET',
                success: function(data) {
                    $('#loadingMessage').hide();
                    
                    if (data.length === 0) {
                        $('#emptyMessage').removeClass('d-none');
                        return;
                    }

                    var tbody = $('#patientsTableBody');
                    tbody.empty();

                    data.forEach(function(item) {
                        var triageBadge = getTriageBadge(item.triageLevel);
                        var vitalInfo = getVitalInfo(item);
                        var arrivalTime = new Date(item.arrivalTime).toLocaleString('tr-TR');
                        
                        var row = '<tr>' +
                            '<td><strong>' + item.queuePosition + '</strong></td>' +
                            '<td>' + item.patientName + '</td>' +
                            '<td>' + item.nationalId + '</td>' +
                            '<td>' + arrivalTime + '</td>' +
                            '<td>' + (item.sourceName || item.source) + '</td>' +
                            '<td>' + triageBadge + '</td>' +
                            '<td>' + vitalInfo + '</td>' +
                            '<td>' +
                                '<a href="/Encounters/Triage/' + item.id + '" class="btn btn-sm btn-warning me-1">' +
                                    '<i class="bi bi-clipboard2-pulse"></i> Triyaj' +
                                '</a>' +
                                '<button class="btn btn-sm btn-info" onclick="showDetails(\'' + item.id + '\')">' +
                                    '<i class="bi bi-eye"></i>' +
                                '</button>' +
                            '</td>' +
                        '</tr>';
                        
                        tbody.append(row);
                    });

                    $('#patientsTable').show();
                    showToast('Başarılı', data.length + ' bekleyen hasta yüklendi.', 'success');
                },
                error: function(xhr, status, error) {
                    $('#loadingMessage').hide();
                    $('#errorMessage')
                        .removeClass('d-none')
                        .html('<i class="bi bi-exclamation-triangle"></i> Hastalar yüklenirken bir hata oluştu: ' + error);
                    showToast('Hata', 'Hastalar yüklenirken bir sorun oluştu.', 'error');
                }
            });
        }

        function getTriageBadge(level) {
            var cssClass = 'triage-' + (level ? level.toLowerCase() : 'undefined');
            var text = getTriageLevelText(level);
            return '<span class="badge ' + cssClass + ' p-2">' + text + '</span>';
        }

        function getTriageLevelText(level) {
            switch(level) {
                case 'Red': return '🔴 Kırmızı (Acil)';
                case 'Yellow': return '🟡 Sarı (Öncelikli)';
                case 'Green': return '🟢 Yeşil (Normal)';
                case 'Blue': return '🔵 Mavi (Ayaktan)';
                default: return '⚪ Belirlenmedi';
            }
        }

        function getVitalInfo(item) {
            if (!item.heartRate && !item.spO2 && !item.temperature) {
                return '<span class="text-muted">Henüz girilmedi</span>';
            }
            
            var html = '<div class="d-flex flex-wrap gap-1">';
            
            if (item.heartRate) {
                var hrClass = item.heartRate > 100 ? 'bg-warning' : (item.heartRate < 60 ? 'bg-warning' : 'bg-secondary');
                html += '<span class="badge ' + hrClass + ' vital-badge">❤️ ' + item.heartRate + ' bpm</span>';
            }
            if (item.spO2) {
                var spClass = item.spO2 < 94 ? 'bg-danger' : 'bg-secondary';
                html += '<span class="badge ' + spClass + ' vital-badge">🫁 ' + item.spO2 + '%</span>';
            }
            if (item.temperature) {
                var tempClass = item.temperature > 38 ? 'bg-warning' : 'bg-secondary';
                html += '<span class="badge ' + tempClass + ' vital-badge">🌡️ ' + item.temperature.toFixed(1) + '°C</span>';
            }
            if (item.systolicBP && item.diastolicBP) {
                html += '<span class="badge bg-secondary vital-badge">🩺 ' + item.systolicBP + '/' + item.diastolicBP + '</span>';
            }
            
            html += '</div>';
            return html;
        }

        function showDetails(encounterId) {
            $.ajax({
                url: '/api/encounters/' + encounterId,
                type: 'GET',
                success: function(data) {
                    var arrivalTime = new Date(data.arrivalTime).toLocaleString('tr-TR');
                    var triageBadge = getTriageBadge(data.triageLevel);
                    
                    // Vital bulgular HTML'i oluştur
                    var vitalsHtml = '';
                    if (data.heartRate) {
                        vitalsHtml += '<div class="row mb-2">' +
                            '<div class="col-6"><span class="detail-label">❤️ Nabız:</span></div>' +
                            '<div class="col-6"><span class="detail-value">' + data.heartRate + ' bpm</span></div>' +
                        '</div>';
                        vitalsHtml += '<div class="row mb-2">' +
                            '<div class="col-6"><span class="detail-label">🫁 SpO2:</span></div>' +
                            '<div class="col-6"><span class="detail-value">' + data.spO2 + '%</span></div>' +
                        '</div>';
                        vitalsHtml += '<div class="row mb-2">' +
                            '<div class="col-6"><span class="detail-label">🩺 Tansiyon:</span></div>' +
                            '<div class="col-6"><span class="detail-value">' + data.systolicBP + '/' + data.diastolicBP + ' mmHg</span></div>' +
                        '</div>';
                        vitalsHtml += '<div class="row mb-2">' +
                            '<div class="col-6"><span class="detail-label">🌡️ Ateş:</span></div>' +
                            '<div class="col-6"><span class="detail-value">' + data.temperature.toFixed(1) + ' °C</span></div>' +
                        '</div>';
                        if (data.complaint) {
                            vitalsHtml += '<hr><div class="row">' +
                                '<div class="col-12"><span class="detail-label">📝 Şikayet:</span><br>' +
                                '<span class="detail-value fst-italic">' + data.complaint + '</span></div>' +
                            '</div>';
                        }
                        if (data.recommendedAction) {
                            vitalsHtml += '<hr><div class="row">' +
                                '<div class="col-12"><span class="detail-label">⚡ Önerilen İşlem:</span><br>' +
                                '<span class="badge bg-info">' + data.recommendedAction + '</span></div>' +
                            '</div>';
                        }
                    } else {
                        vitalsHtml = '<div class="text-center text-muted py-3">' +
                            '<i class="bi bi-clipboard-x" style="font-size: 2rem;"></i>' +
                            '<p class="mt-2">Henüz triyaj değerlendirmesi yapılmamış</p>' +
                        '</div>';
                    }
                    
                    var html = '<div class="row">' +
                        '<div class="col-md-6">' +
                            '<div class="card mb-3">' +
                                '<div class="card-header bg-primary text-white">' +
                                    '<i class="bi bi-person-fill"></i> Hasta Bilgileri' +
                                '</div>' +
                                '<div class="card-body">' +
                                    '<p><span class="detail-label">Ad Soyad:</span> <span class="detail-value">' + data.patientName + '</span></p>' +
                                    '<p><span class="detail-label">T.C. Kimlik:</span> <span class="detail-value">' + data.nationalId + '</span></p>' +
                                    '<p><span class="detail-label">Geliş Zamanı:</span> <span class="detail-value">' + arrivalTime + '</span></p>' +
                                    '<p><span class="detail-label">Geliş Şekli:</span> <span class="detail-value">' + data.source + '</span></p>' +
                                    '<p><span class="detail-label">Durum:</span> <span class="badge bg-' + (data.status === 'Waiting' ? 'warning' : 'success') + '">' + (data.status === 'Waiting' ? 'Bekliyor' : data.status) + '</span></p>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="col-md-6">' +
                            '<div class="card mb-3">' +
                                '<div class="card-header bg-warning">' +
                                    '<i class="bi bi-clipboard2-pulse"></i> Triyaj Bilgileri' +
                                '</div>' +
                                '<div class="card-body">' +
                                    '<p><span class="detail-label">Triyaj Seviyesi:</span> ' + triageBadge + '</p>' +
                                    '<hr>' +
                                    vitalsHtml +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';

                    $('#patientDetailBody').html(html);
                    $('#triageLink').attr('href', '/Encounters/Triage/' + encounterId);
                    
                    var modal = new bootstrap.Modal(document.getElementById('patientDetailModal'));
                    modal.show();
                },
                error: function() {
                    showToast('Hata', 'Hasta detayları yüklenemedi.', 'error');
                }
            });
        }
    </script>
}
